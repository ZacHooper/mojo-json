from utils.variant import Variant

alias JSON_QUOTE = '"'
alias JSON_WHITESPACE = " \t\n"
alias JSON_SYNTAX = "{}[],:"


alias AnyJsonType = Variant[String, Int, Float64, Bool, NoneType]


@value
struct LexResult:
    var value: AnyJsonType
    var is_null: Bool


fn lex_string(inout string: String) raises -> LexResult:
    var json_string: String = ""

    if string[0] == JSON_QUOTE:
        string = string[1:]
    else:
        return LexResult(None, True)

    for i in range(len(string)):
        if string[i] == JSON_QUOTE:
            string = string[i + 1 :]
            return LexResult(json_string, False)
        else:
            json_string += string[i]

    raise Error("Expected end-of-string quote")


fn lex_number(inout string: String) raises -> LexResult:
    var json_number: String = ""
    var number_characters = "1234567890-e."

    for i in range(len(string)):
        var c = string[i]
        if c in number_characters:
            json_number += c
        else:
            break

    # Remove the number from the full JSON String
    string = string[len(json_number) :]

    if not len(json_number):
        return LexResult(None, True)

    if "." in json_number:
        var float_string_split = json_number.split(".")
        var integer_part = atol(float_string_split[0])
        var decimal_part = atol(float_string_split[1])
        var num = integer_part + (decimal_part / 10)
        return LexResult(num, False)

    return LexResult(atol(json_number), False)


def lex_bool(inout string: String) -> LexResult:
    if string.startswith("true"):
        string = string[4:]
        return LexResult(True, False)
    elif string.startswith("false"):
        string = string[5:]
        return LexResult(False, False)
    else:
        return LexResult(None, True)


def lex_null(inout string: String) -> LexResult:
    if string.startswith("null"):
        string = string[4:]
        return LexResult(None, True)
    else:
        return LexResult(None, False)


def lex(string: String) -> List[AnyJsonType]:
    var tokens = List[AnyJsonType]()

    while len(string):
        var json_string = lex_string(string)
        if json_string.is_null == False:
            tokens.append(json_string.value)
            continue

        var json_number = lex_number(string)
        if json_number.is_null == False:
            tokens.append(json_number.value)
            continue

        var json_bool = lex_bool(string)
        if json_bool.is_null == False:
            tokens.append(json_bool.value)
            continue

        var json_null = lex_null(string)
        if json_null.is_null == True:
            tokens.append(None)
            continue

        if string[0] in JSON_WHITESPACE:
            string = string[1:]
        elif string[0] in JSON_SYNTAX:
            tokens.append(string[0])
            string = string[1:]
        else:
            raise Error("Unexpected character: " + string[0] + " Near: " + string[1:])

    return tokens


fn any_json_type_to_string(value: AnyJsonType) raises -> String:
    if value.isa[String]():
        var string_value = value.get[String]()[]
        if string_value in JSON_SYNTAX:
            return string_value
        else:
            return '"' + value.get[String]()[] + '"'
    elif value.isa[Int]():
        return str(value.get[Int]()[])
    elif value.isa[Float64]():
        return str(value.get[Float64]()[])
    elif value.isa[Bool]():
        return str(value.get[Bool]()[])
    elif value.isa[NoneType]():
        return "null"
    else:
        raise Error("Unknown type")


fn main() raises:
    var json = """
    {
        "name": "John",
        "age": 30,
        "wage": 25.4,
        "is_student": false,
        "has_job": true,
        "is_null": null,
        "nickname": ""
    }
    """

    var tokens = lex(json)
    for token in range(len(tokens)):
        var token_str = any_json_type_to_string(tokens[token])
        print(token_str, end="")
